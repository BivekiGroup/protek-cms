Упрощение формы добавления юрлица - скрытие 3 секций после автозаполнения по ИНН, кнопка "Редактировать вручную" для детальной правки - 20
Исправление ошибки добавления товара в корзину - приведение deliveryTime к строке через String() в ProductPriceHeader, добавление toast уведомлений с названием товара - 5
Улучшение валидации API загрузки цен из 1С - добавлена проверка на пустой SKU после нормализации, более понятные сообщения об ошибках - 10
Добавление полей габаритов в API каталога 1С - добавление полей depth (длина), width (ширина), height (высота) в Prisma схему Product, обновление Zod валидации в /api/1c/catalog/products, обработка новых полей в логике создания/обновления товаров, обновление документации на странице интеграции 1C - 15
Исправление отображения иерархии категорий при редактировании товара - добавление рекурсивных функций findCategoriesById и flattenCategories для корректного поиска категорий в дереве, обновление селектора категорий для показа полной иерархии с отступами, теперь категории товара отображаются корректно независимо от уровня вложенности - 10
Добавление блока авторизации для неавторизованных пользователей в корзине - интеграция компонента UnauthenticatedCart с проверкой токена через localStorage, отображение блока "ТОЛЬКО ДЛЯ ЮРЛИЦ" с кнопкой входа и итогами заказа для пользователей с товарами в корзине (правая колонка), создание элегантной карточки с иконкой пользователя, заголовком "Вход для юридических лиц", описанием и кнопкой "Войти в систему" в empty state пустой корзины (светлый градиентный фон, красная рамка, круглая иконка с градиентом), добавление полных CSS стилей для компонента (темный градиентный блок с радиальным красным градиентом для правой колонки, итоги заказа, disabled кнопка оформления, чекбокс согласия) - ОТКАЧЕНО (восстановлено из git) - 35
Исправление определения типа профиля клиента - если у клиента есть хотя бы одно юридическое лицо в legalEntities, общий статус "Тип профиля" показывает "Юр. лицо" вместо "Физ. лицо" - добавлено поле legalEntities (id, shortName, fullName) в GraphQL запрос GET_CLIENTS, обновлен интерфейс Client с добавлением массива legalEntities, переработана функция getClientTypeLabel для проверки наличия юр.лиц перед определением типа, обновлен вызов функции с передачей всего объекта клиента вместо только типа, исправлена ошибка GraphQL "Cannot return null for non-nullable field Client.legalEntities" - добавлен include legalEntities во все resolver'ы возвращающие клиента (clients, client, clientMe, createClient, updateClient, confirmClient), добавлена нормализация данных для гарантии что legalEntities всегда массив а не null, исправлена страница карточки клиента - удален селектор типа пользователя (теперь только для чтения с автоопределением по наличию юр.лиц), удалены устаревшие поля юр.лица из формы общих настроек (ИНН, КПП, ОГРН и т.д.), обновлен заголовок страницы клиента для корректного отображения типа на основе legalEntities, добавлена подсказка показывающая количество юр.лиц - 30
Изменение порядка колонок цен в каталоге товаров - поменяны местами колонки "Цена сайт" и "Цена опт" в таблице ProductList, теперь порядок: Остаток → Цена сайт → Цена опт → Сайт, обновлены заголовки таблицы и ячейки данных - 5
Реорганизация таблицы клиентов - изменена структура колонок (Номер → Тип профиля (ИП/ООО) → ИНН → Наценка → Контактное лицо → Телефон → Email → Дата рег → Статус → Действия), добавлены функции getClientProfileType (определяет ИП или ООО по shortName первого юр.лица) и getClientINN (берет ИНН из первого юр.лица или основного клиента), вся строка таблицы теперь кликабельна с hover эффектом, убрано выпадающее меню с кнопкой редактирования (три точки), убрано синее выделение имени клиента, добавлен stopPropagation для кнопки "Войти от имени", добавлено поле inn в GraphQL запрос legalEntities, обновлен интерфейс Client с полем inn в legalEntities - 20
Добавление модалки подтверждения клиента на дашборде - при клике на неподтвержденного клиента открывается модалка с подтверждением и отправкой письма, при клике на подтвержденного клиента открывается страница редактирования, добавлена мутация CONFIRM_CLIENT, добавлены state (confirmDialogOpen, selectedClient) и функции handleClientClick и handleConfirmClient, карточки клиентов стали кликабельными с cursor-pointer, модалка показывает имя клиента и email для отправки уведомления, toast уведомления об успехе/ошибке, refetch списка клиентов после подтверждения - 25
Оптимизация отображения товаров в корзине - уменьшены отступы (padding: 12px 16px, marginBottom: 8px), удалено дублирование названия товара (убрано описание description, название показывается один раз после бренда/артикула), уменьшены размеры элементов для компактности как в результатах поиска (чекбокс 18px, иконки 18px, кнопки счетчика 24px, шрифты уменьшены на 1-3px), переставлен порядок: сначала бренд/артикул серым текстом 13px, затем название товара 14px жирным, размер цены уменьшен до 17px, border-radius уменьшен до 12px для карточек и 6px для элементов управления - 15
Добавление индикатора количества товара в корзине на странице поиска - заменена зеленая галочка на красный бейдж с числом, показывающий сколько единиц товара уже лежит в корзине, бейдж появляется в правом верхнем углу кнопки "В корзину" для каждого предложения, использует функцию getExistingCartQuantity для подсчета количества, стили: красный фон (#dc2626), белый текст, круглая форма (minWidth: 20px, height: 20px), шрифт 11px жирный, тень для лучшей видимости, tooltip показывает "В корзине: X шт." - 10
Оптимизация размеров сайдбаров и таблицы в каталоге товаров - уменьшен левый сайдбар категорий с w-80 (320px) до w-56 (224px), уменьшен заголовок "Каталог товаров" до "Каталог" (text-base), кнопка "Добавить категорию" стала компактнее (size="sm"), в CategoryTree уменьшены отступы: paddingLeft с level*16+12 до level*12+8, размеры элементов: py-2 -> py-1.5, text-sm -> text-xs, иконки с w-3 h-3 до w-2.5 h-2.5, счетчик товаров text-xs -> text-[10px], оптимизирован grid таблицы ProductList для предотвращения наложения колонок: уменьшены минимальные размеры колонок, увеличен gap с gap-1 до gap-1.5, установлены более разумные minmax значения для каждой колонки, дополнительная оптимизация таблицы - дальнейшее уменьшение всех колонок (чекбокс 26px, внутр.код 55-70px, фото 42-56px, название 110px-1fr, категория 90-180px, артикул 60-80px, остаток 48-65px, цены 55-75px, сайт 42-52px, действия 60-75px), уменьшен gap с 1.5 до 1, уменьшены padding в заголовке (px-2.5 -> px-2) и шрифты (11px -> 10.5px в заголовке, 11.5px -> 11px в строках), уменьшен padding в колонке действий (pr-4 -> pr-2, pr-1.5 -> pr-1), уменьшены кнопки действий (h-8 w-8 -> h-7 w-7, иконки w-4 h-4 -> w-3.5 h-3.5), уменьшен gap между кнопками (gap-1 -> gap-0.5) - 25
Оптимизация номеров клиентов и отображения типа профиля - сокращены номера клиентов до формата CL + 4 цифры (CL1000, CL1001...) для обычных клиентов и AN + 4 цифры (AN1000) для анонимных, обновлена логика генерации в createClient resolver (resolvers.ts:7553-7569) с фильтрацией по префиксу CL и API импорта клиентов (api/clients/import/route.ts:82-94), создан и выполнен скрипт миграции существующих клиентов (scripts/migrate-client-numbers.ts) с преобразованием ANON_ в AN, обновлено 7 клиентов (6 обычных CL1000-CL1005 и 1 анонимный AN1000), переработана функция getClientProfileType для отображения полного названия с типом организации (ИП/ООО/АО/ПАО/ЗАО + название без префикса) вместо просто "ИП" или "ООО", добавлена обработка всех типов организаций с автоматическим удалением дублирующегося префикса из shortName - 30
Оптимизация главной панели дашборда - уменьшены отступы страницы (p-6 -> p-4, space-y-6 -> space-y-4, gap-6 -> gap-4), уменьшены заголовки (h1: text-3xl -> text-2xl, mb-2 -> mb-1), компактнее карточки секций (py-3 вместо стандартных, text-base для заголовков), уменьшены размеры элементов в списках заказов и клиентов (p-4 -> p-3, space-y-4 -> space-y-2, text-sm/text-xs для текста), уменьшены иконки (h-5 w-5 -> h-4 w-4, h-4 w-4 -> h-3 w-3), все карточки статистики сверху теперь кликабельны и ведут на соответствующие страницы (Новые заказы -> /dashboard/orders, Новые клиенты -> /dashboard/clients, Неподтверждённые -> /dashboard/clients?tab=unverified с автоматическим переключением на вкладку "Ожидают проверки", Аналитика -> /dashboard/analytics), добавлен hover эффект для карточек (hover:shadow-md), строки заказов полностью кликабельны (обернуты в Link), добавлен cursor-pointer для всех интерактивных элементов, реализована поддержка URL параметра tab в странице клиентов для автоматического переключения вкладок - 25
Добавление модалки подтверждения клиента в таблицу клиентов - при клике на бейдж статуса "Не подтвержден" открывается модалка подтверждения (аналогично дашборду), добавлена мутация CONFIRM_CLIENT и state управления модалкой (confirmDialogOpen, selectedClient), бейдж "Не подтвержден" стал кликабельным с cursor-pointer и hover эффектом, добавлен stopPropagation для предотвращения перехода на страницу клиента, модалка показывает имя и email клиента, toast уведомления об успехе/ошибке, refetch списка клиентов после подтверждения - 20
Добавление сокращения ФИО в типе профиля клиента - функция getClientProfileType теперь сокращает ФИО для ИП до формата "Фамилия И. О." (например, "ИП Данилов Лев Ильич" отображается как "ИП Данилов Л. И."), добавлена вспомогательная функция abbreviateName для обработки различных форматов имен (1 слово - без изменений, 2 слова - Фамилия И., 3+ слова - Фамилия И. О.), для ООО/АО/ПАО/ЗАО названия остаются без сокращений так как это обычно названия компаний а не ФИО - 10
Добавление счетчиков товаров и цветовой индикации в дерево категорий - добавлено поле _count с подсчетом products во все уровни вложенности категорий в GraphQL запросе GET_CATEGORIES (queries.ts:517-537), обновлен компонент CategoryTree для отображения количества товаров рядом с каждой категорией и подкатегорией, добавлена цветовая индикация для различения категорий с товарами и пустых категорий (категории с товарами: text-gray-700 обычные / text-blue-700 выбранные, счетчик text-gray-500 жирный; пустые категории: text-gray-400 обычные / text-blue-400 выбранные, счетчик text-gray-300), счетчик теперь отображается для всех категорий (даже с 0 товаров) для лучшей визуальной обратной связи - 15
Исправление подсчета товаров в категориях - добавлена рекурсивная функция getTotalProductCount (CategoryTree.tsx:63-67) для подсчета всех товаров включая подкатегории, теперь счетчик показывает общее количество товаров во всей ветке категории а не только прямые товары (например, "Двигатель" теперь показывает сумму товаров из всех подкатегорий: Блок-картер, Головка блока цилиндров, Система смазки и т.д.), обновлена логика определения hasProducts на основе totalProducts - 5
Оптимизация высоты карточек товаров в корзине - уменьшены вертикальные отступы карточки (padding: 12px 16px -> 8px 14px, marginBottom: 8px -> 6px), уменьшен gap между элементами (12px -> 10px), уменьшены размеры текста (brand/article: 13px -> 12px, название: 14px -> 13px, доставка: 12px -> 11px), уменьшены иконки (действия: 18px -> 16px, доставка: 14px -> 12px), уменьшены кнопки счетчика (24px -> 20px, иконки 10px -> 8px, input: 35px -> 30px, fontSize: 13px -> 12px), уменьшены размеры цен (основная цена: 17px -> 15px, старая цена: 12px -> 11px, цена за единицу: 12px -> 11px, скидка: 11px -> 10px), уменьшены отступы между элементами правой части (gap: 8px -> 5px, между кнопками: 6px -> 4px), общее уменьшение высоты карточки примерно на 25-30% - 15
Полная реструктуризация карточки товара в корзине в компактный однострочный формат - изменена структура с вертикальной на горизонтальную (alignItems: flex-start -> center), весь контент теперь размещен в одну строку, уменьшены отступы карточки (padding: 8px 14px -> 6px 12px, marginBottom: 6px -> 4px, borderRadius: 12px -> 8px), уменьшен чекбокс (18px -> 16px), информация о товаре размещена горизонтально с сокращением текста (display: flex, alignItems: center), бренд/артикул и название в одной строке с ellipsis, доставка отображается компактно справа от названия (fontSize: 10px, max-width: 120px), счетчик количества уменьшен (кнопки: 20px -> 18px, input: 30px -> 26px, fontSize: 12px -> 11px, gap: 4px -> 3px), цена и скидка в одну горизонтальную линию (fontSize: 15px -> 14px, старая цена и бейдж скидки рядом), кнопки действий уменьшены (16px -> 14px), общая высота карточки уменьшена примерно на 50% по сравнению с оригиналом - 25
Улучшение кнопки "Все товары" в каталоге - преобразование текстового элемента в полноценную кнопку (компонент Button) с четким визуальным оформлением, добавлена активная синяя подсветка (bg-blue-600) когда кнопка выбрана и outline стиль когда не выбрана, размер sm с полной шириной (w-full) и выравниванием по левому краю (justify-start), добавлен отступ снизу для отделения от списка категорий - 10
Замена иконки подсказки на странице реквизитов - заменена иконка восклицательного знака на иконку лампочки (как в корзине) в компоненте LegalEntityListBlock, добавлена короткая подпись "Подсказка" рядом с иконкой для привлечения внимания, добавлены hover эффекты (transition-colors, group-hover:text-yellow-600) для иконки и текста, изменен цвет иконки с text-yellow-500 на более привлекательный желтый, обновлены оба блока (пустой список и список с юридическими лицами) - 15
Исправление выравнивания колонок в таблице заказов - переработана структура таблицы товаров в заказах (ProfileOrdersMain.tsx:325-361), заменен flex с gap-5 на фиксированные ширины с ml-5 отступами, добавлен shrink-0 для предотвращения сжатия колонок, установлены фиксированные ширины (№: 9px, Производитель: 130px, Артикул: 120px, Наименование: flex-1, Кол-во: 80px с text-center, Стоимость: 110px с text-right), добавлен truncate для длинных текстов, теперь колонки количества и стоимости корректно выравниваются по всей таблице - 10
Исправление структуры карточки товара в корзине - переработана разметка CartItemNew.tsx для фиксированного выравнивания элементов независимо от длины названия и артикула, заменен gap на marginRight для контроля отступов, добавлен flexShrink: 0 для всех ключевых элементов, установлены фиксированные ширины (чекбокс: 20px, бренд/артикул: 180px, доставка: 120px, счетчик: 90px, цена: 150px, действия: 50px), блок названия товара остается flex: 1 и сжимается с ellipsis при нехватке места, теперь все названия товаров начинаются строго с одной позиции независимо от длины бренда/артикула, все правые элементы (счетчик, цена, кнопки) также имеют фиксированное положение - 15
Исправление создания заказа по счету - исправлена генерация PDF счета и сохранение invoiceUrl в БД (resolvers.ts:10536-10595), добавлено включение legalEntities в запрос клиента для PDF (вместо несуществующего legalEntity), обновленный заказ с invoiceUrl теперь возвращается из мутации createOrder (раньше возвращался без invoiceUrl), исправлен include для fullOrder при генерации PDF, добавлено детальное логирование для отладки (paymentMethod, статус заказа, этапы генерации PDF), исправлен URL fallback для скачивания счета в ProfileOrdersMain.tsx (было /api/api/, стало /api/), исправлена установка статуса заказа - заменена строка 'PENDING' на enum PrismaOrderStatus.PENDING (строка 10458) для корректного сохранения статуса "Ожидает оплаты" вместо "Обрабатывается", добавлена проверка paymentMethod === 'invoice' на странице успеха (success.tsx:118-122) для пропуска автоматического подтверждения оплаты, теперь после создания заказа по счету статус корректно устанавливается как PENDING, клиент получает ссылку на PDF счет и может его скачать - 25
Исправление скачивания счета на странице успеха оплаты и в личном кабинете - заменена простая ссылка <a> на кнопку с обработчиком onClick (success.tsx:333-394, ProfileOrdersMain.tsx:422-483), который скачивает PDF счет через fetch с Authorization заголовком из localStorage, исправлен URL генерации (.replace('/api/graphql', '') вместо .replace('/graphql', '')), добавлена обработка ошибок при скачивании с alert уведомлением пользователя, файл скачивается с правильным именем "Счет_{номер_заказа}.pdf", решена проблема "Токен авторизации не предоставлен" при попытке открыть счет в новой вкладке через обычную ссылку, на странице заказов если invoiceUrl уже сгенерирован - открывается напрямую в новой вкладке (S3 URL публичный), иначе генерируется через API с токеном - 20
Улучшение модалки просмотра заказов в админке - вся строка таблицы теперь кликабельна для открытия деталей заказа (убрана кнопка с иконкой глаза), добавлен hover эффект для строк (hover:bg-gray-50), модалка уменьшена с max-w-4xl до max-w-2xl для компактности, добавлен скролл для контента модалки (max-h-[90vh], overflow-y-auto, flex-layout), переработана структура модалки с одноколоночным layout вместо двух колонок, товары отображаются в виде компактных карточек вместо таблицы, уменьшены размеры текста (text-sm для основного текста, text-xs для деталей), header и footer модалки зафиксированы (flex-shrink-0), контент модалки прокручивается независимо, добавлен stopPropagation для колонки действий чтобы не открывать модалку при изменении статуса или удалении - 15
Улучшение страницы заказов в админке - добавлены кликабельные карточки статистики для фильтрации (Всего заказов -> ALL, В обработке -> PROCESSING, Выполнено -> DELIVERED, Отменено -> CANCELED) с hover эффектом, заменен вывод клиента на юрлицо (берется первое юрлицо из legalEntities клиента), добавлена функция getShortOrderNumber для сокращения номера заказа (ORD-20250101-00001 -> ORD-001), уменьшена высота строк таблицы (py-2, text-xs для большинства текстов), добавлена раскрываемая вторая строка с детальной информацией о заказе (кнопка с иконкой ChevronDown/ChevronUp в первой колонке, expandedOrders state, toggleOrderExpand функция), в раскрываемой части отображаются контакты (email, phone), адрес доставки, комментарий, список всех товаров с ценами и количеством, итоговые суммы, фон bg-gray-50 для раскрываемой строки, компактный дизайн с text-xs, добавлены поля legalEntities в GraphQL запрос GET_ORDERS внутри client объекта, обновлен интерфейс Order с legalEntities в client, убрана большая модалка просмотра деталей (заменена на раскрываемую строку) - 20
Изменение цвета бейджа количества товара в корзине на зеленый в поиске - изменен цвет backgroundColor с #dc2626 (красный) на #16a34a (зеленый) в компоненте CoreProductCard для бейджа показывающего количество товара уже добавленного в корзину, обновлен бейдж на строке 723, теперь бейдж отображается зеленым кружком с белым текстом - 5
Уменьшение длины генерируемого пароля до 6 символов - изменена дефолтная длина пароля в функции generatePassword с 12 на 6 символов (auth-utils.ts:32), обновлен комментарий функции, теперь при регистрации клиентов и отправке пароля на почту генерируется короткий 6-значный пароль содержащий заглавные буквы, строчные буквы, цифры и спецсимволы - 5
Улучшение дропдауна истории поиска в шапке - изменено отображение в SearchHistoryDropdown.tsx для показа только номера артикула вместо полного запроса с брендом для типов ARTICLE/OEM (lines 76-78), уменьшены все размеры компонента для более компактного вида (max-height: 180px, padding: 8px 14px, icon: 24px, font-size: 13px для запроса и 11px для типа, margin-top: 8px, border-radius: 12px), теперь дропдаун занимает меньше места и показывает только релевантную информацию без дублирования - 10
Смена позиций иконки поиска и кнопки истории в шапке - поменяны местами элементы в Header.tsx: кнопка истории поиска (HistoryIcon) теперь слева, кнопка поиска (лупа) справа внутри div.search-field-actions (lines 555-581), увеличен gap между элементами с помощью inline style gap: '12px', теперь порядок соответствует пожеланиям пользователя с большим визуальным разделением между кнопками - 5
Добавление бейджа количества в топ предложениях серчрезалта - добавлена функция getExistingCartQuantity в BestPriceCard.tsx для подсчета товаров уже добавленных в корзину, добавлен импорт cartState из useCart хука, добавлен зеленый бейдж (backgroundColor: #16a34a) в правом верхнем углу кнопки "Купить" показывающий количество товара в корзине, бейдж отображается только если existingQty > 0, включает tooltip "В корзине: X шт." при наведении, использует те же стили что и в CoreProductCard (minWidth: 20px, height: 20px, fontSize: 11px, boxShadow, padding: 0 4px) - 10
Сделать строки товаров кликабельными в profile-orders - добавлен импорт useRouter в ProfileOrdersMain.tsx, добавлена инициализация router в компоненте, строки товаров теперь кликабельны с cursor-pointer и hover:bg-gray-50, при клике на строку происходит переход на страницу search-result с параметрами article и brand, добавлен title tooltip "Перейти к поиску товара" для улучшения UX, клик работает только если у товара есть артикул и бренд - 10
Добавление кнопки избранного в profile-orders - добавлен импорт useFavorites из FavoritesContext в ProfileOrdersMain.tsx, добавлены функции addToFavorites, removeFromFavorites и isFavorite из хука, добавлена дополнительная колонка шириной 40px в заголовок таблицы товаров, для каждого товара добавлена кнопка с иконкой сердца (20x20px), кнопка заполняется красным цветом (#EC1C24) если товар в избранном или остается незаполненной (stroke: #9CA3AF) если нет, при клике на кнопку товар добавляется/удаляется из избранного, добавлен stopPropagation чтобы не срабатывал клик по строке, добавлен hover:scale-110 для анимации при наведении, tooltip показывает "Добавить в избранное" или "Удалить из избранного" - 15
Реализация выполнения поиска при клике на элемент истории в дропдауне шапки - обновлен GraphQL запрос GET_RECENT_SEARCH_QUERIES для возврата полей brand и articleNumber (search-history.ts:27-41), изменен интерфейс SearchHistoryDropdown для передачи полного объекта item вместо только searchQuery (SearchHistoryDropdown.tsx:7), обновлена логика onClick в дропдауне для передачи полного объекта (строка 57), переработан handleHistoryItemClick в Header.tsx для выполнения навигации и поиска по типу (как в ProfileHistoryItem.tsx:47-67): для VIN/PLATE -> /vehicle-search-results, для ARTICLE/OEM -> /search-result с article и brand параметрами, для TEXT -> /search с query параметром, для PART_VEHICLES -> /vehicles-by-part, уменьшен лимит загружаемых записей истории с 5 до 3 в обоих местах вызова getSearchHistory (Header.tsx:423, 437), теперь дропдаун истории работает идентично странице profile-history с автоматическим выполнением поиска и переходом на страницу результатов, показывает только первые 3 уникальные записи - 15
Исправление отображения количества товара в корзине в топ предложениях - исправлена логика функции getExistingCartQuantity в BestPriceCard.tsx для корректного сопоставления товаров в корзине, добавлена проверка наличия полей offer.articleNumber и offer.brand перед сравнением (строка 57), добавлена нормализация артикулов и брендов через toUpperCase().trim() для надежного сравнения независимо от регистра и пробелов (строки 58-61), улучшена структура проверок с приоритетом offerKey > productId > article+brand, добавлено детальное логирование для отладки (console.log структуры offer, найденных совпадений и итогового количества), теперь бейдж с количеством товара в корзине корректно отображается во всех трех блоках топ предложений (Самая низкая цена, Самая быстрая доставка, Самый дешевый аналог) - 10
Оптимизация производительности отображения бейджа количества в топ предложениях - добавлен импорт useMemo в BestPriceCard.tsx (строка 1), внедрено мемоизирование вычисления existingCartQuantity с зависимостями от cartState?.items и offer (строки 79-83), заменен IIFE на прямое условное отображение с использованием мемоизированного значения (строка 260), добавлено детальное логирование в useMemo для отладки вывода количества (строка 81), теперь количество товара в корзине вычисляется один раз при изменении корзины или offer вместо при каждом рендере, что значительно улучшает производительность компонента - 5
Исправление проверки наличия товаров в корзине для топ предложений - улучшена проверка cartState в функции getExistingCartQuantity (BestPriceCard.tsx:40-43), теперь проверяется не только cartState?.items но и cartState.items.length для корректной обработки случая когда items = undefined при первой загрузке страницы, изменены зависимости useMemo с [cartState?.items, offer] на [cartState, offer] для гарантированного пересчета при загрузке корзины, добавлено детальное логирование состояния корзины (hasCartState, itemsLength), теперь бейдж корректно отображается после загрузки данных корзины - 5
Исправление деструктуризации CartContext в BestPriceCard - обновлена деструктуризация хука useCart с { addItem, cartState } на { addItem, state: cartState } (BestPriceCard.tsx:25), это исправило проблему когда cartState был undefined/false потому что useCart возвращает объект с полем state а не cartState напрямую согласно интерфейсу CartContextType, теперь бейдж с количеством товара в корзине корректно отображается во всех трех блоках топ предложений (Самая низкая цена, Самая быстрая доставка, Самый дешевый аналог) - 5
Добавление кнопки перехода на карточку товара в результатах поиска - добавлен импорт Link из next/link в CoreProductCard.tsx (строка 3), добавлена логика поиска первого internal offer с productId среди всех предложений товара (строка 154), добавлена синяя кнопка "Подробнее" с иконкой внешней ссылки рядом с названием товара (строки 812-844), кнопка отображается только если товар есть в базе данных (есть internal offer с productId), кнопка ведет на страницу /card?id={productId}, добавлены hover эффекты (изменение цвета и поднятие на 1px), стили: синий фон (#2563eb), белый текст, скругленные углы (6px), размер шрифта 12px, padding 4px 10px, gap между иконкой и текстом 6px - 15
Исправление горизонтального overflow на странице корзины - добавлен overflowX: 'hidden' к секции корзины (cart.tsx:30), добавлены width: '100%' и boxSizing: 'border-box' к основному контейнеру (строки 36-37), добавлены width и maxWidth: '100%' к grid контейнеру (строки 45-46), добавлен overflow: 'hidden' к левой колонке со списком товаров (строка 49), в CartItemNew.tsx добавлен overflow: 'hidden' к основной карточке (строка 74) и внутреннему flex контейнеру (строка 83), добавлены maxWidth: '100%' и overflow: 'hidden' к контейнеру информации о товаре (строки 132, 136), добавлен maxWidth: '180px' к блоку бренда/артикула (строка 142), добавлены maxWidth: '100%' и overflow: 'hidden' к блоку названия товара (строки 166, 168), теперь длинные названия товаров корректно обрезаются с ellipsis и не вызывают горизонтальный скролл страницы - 15
Оптимизация страницы подтверждения заказа для компактности - уменьшены все отступы и размеры элементов в checkout.tsx для более аккуратного и компактного вида, уменьшен padding секции с 24px 0 40px 0 до 16px 0 24px 0 (строка 214), уменьшена ширина правой колонки с 400px до 360px (строка 225), уменьшен gap между колонками с 16px до 12px (строка 226), уменьшен gap левой колонки с 8px до 6px (строка 230), все карточки: borderRadius с 12px до 10px, padding с 16px 20px до 12px 16px, уменьшены все fontSize (labels: 13px -> 11px, values: 15px -> 13px, secondary: 13px -> 12px), уменьшены иконки с 20px до 18px, правая колонка: sticky top с 20px до 16px, padding с 20px до 14px 16px, heading с 16px до 14px, payment cards padding с 12px до 10px, radio с 18px до 16px, label fontSize с 14px до 13px, description с 12px до 11px, divider margin с 20px 0 до 12px 0, cost items fontSize с 14px до 12px/13px, "Итого" label с 16px до 14px, total price с 20px до 18px, error padding с 12px до 10px, error fontSize с 13px до 12px, button padding с 14px до 12px, button fontSize с 15px до 14px, consent gap с 8px до 6px, consent fontSize с 12px до 11px, блок "Информация о доставке": padding с 14px 16px до 12px 16px, heading margin с 10px до 8px, heading fontSize с 14px до 13px, gap между датами с 12px до 8px, карточки дат: padding с 12px до 10px, borderRadius с 8px до 6px, icon с 16px до 14px, gap с 8px до 6px, date fontSize с 14px до 12px, info fontSize с 13px до 11px, warning: padding с 16px до 10px, icon с 20px до 16px, gap с 12px до 8px, title fontSize с 14px до 12px, description с 13px до 11px, блок "Товары в заказе": padding с 20px до 12px 16px, heading margin с 16px до 10px, heading fontSize с 16px до 13px, gap между товарами с 16px до 10px, product item gap с 12px до 10px, paddingBottom с 16px до 10px, name fontSize с 14px до 12px, brand/article fontSize с 12px до 11px, quantity fontSize с 12px до 11px, price fontSize с 15px до 13px, общее уменьшение занимаемого пространства примерно на 30-35% по вертикали - 35
Добавление модального окна предупреждения о недостатке товара на складе при оформлении заказа - добавлены state для showStockWarningModal и stockWarningItems в checkout.tsx (строки 34-35), обновлен обработчик ошибок в handleSubmit для парсинга ошибки "Недостаточно товара" через регулярное выражение (строки 178-187), при обнаружении ошибки недостатка товара показывается модальное окно вместо обычного текста ошибки, добавлено модальное окно с желтой иконкой предупреждения и заголовком "Недостаточно товара на складе" (строки 1161-1300), в модалке отображается информация о товаре (название, доступное количество, запрошенное количество) на желтом фоне (#FEF3C7), текст объяснения с предложением вернуться в корзину и изменить количество, две кнопки: "Вернуться в корзину" (красная, перенаправляет на /cart) и "Остаться на странице" (серая outline, закрывает модалку), модалка появляется поверх всего контента с полупрозрачным фоном (rgba 0.5), имеет адаптивный дизайн с maxWidth 500px и padding 20px, использует единый стиль Onest шрифта - 20
Улучшение системы проверки наличия товара и модального окна при оформлении заказа - добавлена функция checkStockAvailability (checkout.tsx:166-185) для проверки наличия внутренних товаров ПЕРЕД отправкой заказа на сервер, функция проверяет только товары с productId и !isExternal, сравнивает доступное количество (item.stock) с запрошенным (item.quantity), при обнаружении недостатка показывается модальное окно БЕЗ отправки заказа, добавлена функция handleOrderWithAvailableQuantity (строки 105-163) для оформления заказа с доступным количеством товара, функция создает модифицированный список товаров где количество товаров с проблемами заменяется на доступное, в комментарий заказа добавляется "ВНИМАНИЕ: Заказ оформлен с доступным количеством товара на складе", обновлено модальное окно с тремя кнопками вместо двух: "Оформить с доступным количеством" (зеленая, #059669, вызывает handleOrderWithAvailableQuantity), "Вернуться в корзину" (красная outline, перенаправляет на /cart), "Отмена" (серая outline, закрывает модалку), кнопки расположены вертикально: главная действие сверху на всю ширину, два второстепенных действия в ряд снизу, все кнопки disabled во время isProcessing, обновлен текст описания в модалке: "Вы можете оформить заказ с доступным количеством или вернуться в корзину для редактирования", теперь пользователь не получает ошибку сервера а видит понятное модальное окно с выбором действий - 25
Оптимизация страницы успешной оплаты для компактности и удаление внутреннего ID заказа - уменьшены все отступы и размеры элементов в success.tsx для более компактного и аккуратного вида (аналогично оптимизации checkout.tsx), уменьшен grid gap с 8 до 5 и pb с 16 до 10 (строка 280), уменьшена ширина правой колонки с 360px до 320px (строка 280), главная секция: rounded-3xl -> rounded-2xl, px-6 py-8 -> px-5 py-6 / px-7 py-8 (строка 281), иконка статуса: h-16 w-16 -> h-12 w-12 (sm: h-20 w-20 -> h-14 w-14), внутренняя иконка с 8x8 до 6x6 (строка 285), заголовок: text-2xl -> text-xl (sm: text-3xl -> text-2xl) (строка 292), label: text-xs tracking-[0.24em] -> text-[10px] tracking-[0.2em] (строка 289), описание: text-base -> text-sm (sm: text-lg -> text-base) (строка 299), детали: gap-6 p-6 -> gap-4 p-4, rounded-2xl -> rounded-xl (строка 315), detail labels: text-xs -> text-[10px], mt-2 -> mt-1.5 (строка 318), detail values: text-lg -> text-base (строка 321), блок счета: p-6 -> p-4, rounded-2xl -> rounded-xl (строка 328), заголовок счета: text-lg -> text-base, mb-3 -> mb-2 (строка 329), текст счета: text-sm -> text-xs, mb-4 -> mb-3 (строка 330), кнопка: padding 0.75rem 1.5rem -> 0.5rem 1rem, fontSize 0.875rem -> 0.813rem, borderRadius 0.75rem -> 0.5rem (строки 396-399), иконка кнопки: mr-2 h-5 w-5 -> mr-1.5 h-4 w-4 (строка 414), блок документов: p-6 -> p-4, rounded-2xl -> rounded-xl (строка 422), заголовок документов: text-lg -> text-base (строка 423), текст документов: text-sm mt-2 -> text-xs mt-1.5 (строка 424), текст номера заказа: text-xs mt-4 -> text-xs mt-3 (строка 429), правая колонка: space-y-6 -> space-y-4 (строка 455), карточка "Что дальше": p-6 -> p-4, rounded-3xl -> rounded-2xl (строка 456), заголовок "Что дальше": text-lg -> text-base (строка 457), список шагов: mt-4 space-y-4 -> mt-3 space-y-3 (строка 458), шаг: gap-4 -> gap-3 (строка 460), иконка шага: h-11 w-11 -> h-9 w-9, внутренняя h-5 w-5 -> h-4 w-4 (строки 461-462), заголовок шага: text-base -> text-sm (строка 465), описание шага: text-sm mt-1 -> text-xs mt-0.5 (строка 466), карточка поддержки: p-6 -> p-4, rounded-3xl -> rounded-2xl (строка 473), gap поддержки: gap-4 -> gap-3 (строка 474), иконка поддержки: h-12 w-12 -> h-10 w-10, rounded-2xl -> rounded-xl (строка 475), внутренняя иконка: h-6 w-6 -> h-5 w-5 (строка 476), space-y поддержки: space-y-3 -> space-y-2 (строка 478), заголовок поддержки: text-lg -> text-base (строка 479), текст поддержки: text-sm -> text-xs (строка 480), ссылки поддержки: text-sm space-y-2 -> text-xs space-y-1.5 (строка 483), расписание: text-white/70 -> text-white/70 text-[11px] (строка 490), баннеры подтверждения: все padding px-4 py-3 -> px-3 py-2, все шрифты text-sm -> text-xs, все иконки h-5 w-5 -> h-4 w-4, описание в error banner text-xs -> text-[11px] (строки 199-231), УДАЛЕН внутренний ID заказа в системе из детального блока (cmhuxwv1o003uudchnefx8hzr) - закомментирован вывод "ID заказа в системе" в detailItems (строки 188-191), теперь клиентам показывается только короткий номер заказа (ORD-1762887855656-US0H1QFN8) и способ оплаты, внутренний ID больше не отображается, общее уменьшение занимаемого пространства примерно на 25-30% по вертикали - 40
Сокращение формата номеров заказов - изменена генерация номеров заказов в resolvers.ts с длинного формата ORD-{timestamp}-{random9} (например ORD-1762888238305-3U59BVELI) на короткий формат ORD-{sequence}-{random5} (например ORD-001-ABC12), теперь используется счетчик заказов через prisma.order.count() для генерации порядкового номера (3 цифры с ведущими нулями), добавлен короткий 5-символьный случайный суффикс вместо 9-символьного, номера заказов стали намного короче и читабельнее для клиентов, сохранена уникальность через комбинацию последовательности и случайной строки (resolvers.ts:10398-10403) - 10
Создание красивой страницы политики конфиденциальности - полностью переработана страница privacy-policy.tsx с современным дизайном, добавлен полный текст политики конфиденциальности в соответствии с ФЗ-152 "О персональных данных", добавлены breadcrumbs для навигации, создана структура из 9 разделов с нумерованными бейджами (красные круглые значки с номерами секций), добавлены иконки SVG для каждого раздела и подраздела, раздел "Какие данные мы собираем" содержит детальное описание данных физических и юридических лиц с иконками галочек, раздел "Цели сбора и обработки данных" оформлен в виде сетки из 6 цветных карточек с градиентами (красная - обработка заказов, синяя - поддержка, зеленая - документооборот, фиолетовая - маркетинг, желтая - улучшение сервиса, голубая - безопасность), добавлены выделенные блоки для важной информации (желтый блок с рамкой для условий передачи данных, зеленый градиентный блок со щитом для защиты данных), контактная информация в красивом синем градиентном блоке с иконками email и офиса, добавлена сетка прав пользователей (2 колонки) с иконками (глаз - доступ, крест - отзыв согласия, корзина - удаление, конверт - контакт), удалена старая страница "Согласие на обработку персональных данных" (всё объединено в одну политику конфиденциальности), исправлена ссылка в Footer.tsx с /confidentiality-policy на /privacy-policy (строка 176), удалена отдельная ссылка "Согласие на обработку персональных данных" из футера (строка 177 удалена), добавлен Footer компонент в низ страницы для единообразия, использован корпоративный шрифт Onest для всего текста, адаптивный дизайн для мобильных устройств (sm:grid-cols-2 для карточек), кнопка "Вернуться на главную" с иконкой стрелки внизу страницы, дата последнего обновления 11.11.2025, заметка о соответствии ФЗ-152 внизу - 35
    50→Удаление вкладки "Покупателям" из навигации в шапке - удалена ссылка с текстом "Покупателям" из навигационного меню в Header.tsx, теперь навигация содержит только: О компании, Оплата и доставка, Гарантия и возврат, Оптовым клиентам, Контакты - 5
    51→Ограничение секции "Новые поступления" одной строкой товаров - добавлено свойство grid-template-rows: 1fr и overflow: hidden к классу .new-arrivals-grid в my.css, изменен дефолтный limit с 8 на 6 в typeDefs.ts (строка 1279) и resolvers.ts (строка 5090), теперь секция на главной странице всегда показывает строго 6 товаров максимум в одну строку (6 на десктопе, 4 на планшетах, 3 на мобильных, 2 на маленьких мобильных, 1 на очень маленьких), остальные товары доступны только на отдельной странице /new-arrivals, предотвращено переполнение на вторую строку - 5
    52→Ограничение секции "Топ продаж" одной строкой товаров - добавлено свойство grid-template-rows: 1fr и overflow: hidden к классу .top-sales-grid в my.css, добавлен .slice(0, 6) к финальному массиву activeTopSalesProducts в TopSalesSection.tsx (строка 116), теперь секция на главной странице всегда показывает строго 6 товаров максимум в одну строку (6 на десктопе, 4 на планшетах, 3 на мобильных, 2 на маленьких мобильных, 1 на очень маленьких), остальные товары доступны только на отдельной странице /top-sales, предотвращено переполнение на вторую строку - 5
    53→Создание интерактивной страницы каталога /catalog - ПОЛНОСТЬЮ ПЕРЕРАБОТАНА страница каталога с интеграцией реальных категорий из БД через GraphQL запрос GET_CATEGORIES, реализована интерактивная навигация по иерархии категорий с state управлением (selectedCategory, breadcrumbs), добавлена функция getCategoryPath для построения пути от корня до выбранной категории, реализована логика клика по категории: если есть подкатегории - показать их, если нет - переход на страницу товаров /catalog/{slug}, ШАПКА С ХЛЕБНЫМИ КРОШКАМИ: добавлен блок section-info с хлебными крошками и заголовком в едином стиле сайта (как на странице корзины), breadcrumbs с кнопками для навигации по уровням (Главная → Каталог → Категория), заголовок h1.heading меняется динамически (Каталог или название категории), счетчик товаров в заголовке с правильными склонениями (товар/товара/товаров), кнопка "Назад" для возврата на предыдущий уровень, СОВРЕМЕННЫЙ ДИЗАЙН: фон #F9FAFB, контейнер maxWidth 1580px padding 0 20px (как на корзине), карточки категорий с белым фоном и тенями (shadow-sm hover:shadow-xl), РАСШИРЕННАЯ СИСТЕМА ИКОНОК: 15+ уникальных иконок из lucide-react для разных категорий (Двигатель→Cog, Тормоза→CircleDot, Подвеска→GitBranch, Фильтры→Filter, Шины→Radio, Диски→Circle, Кузов→Square, Трансмиссия→Settings, Салон→Box, Охлаждение→Gauge, Детали→Puzzle, Масла→Droplet, Электрика→Zap, Инструменты→Wrench, АКБ→Battery, Химия→Sparkles, Аксессуары→Tag), функция getCategoryIcon определяет иконку по ключевым словам в названии, иконки в градиентных квадратах (from-[#EC1C24]/10 to-[#EC1C24]/5) размером 56px с красными иконками внутри, градиентный фон при ховере (group-hover:from-[#EC1C24]/5), декоративные размытые круги в углу карточек (blur-2xl), красный индикатор снизу карточек появляющийся при ховере (gradient from-[#EC1C24] to-[#FF3838]), счетчик товаров ТОЛЬКО если > 0 с правильными склонениями, бейдж с количеством подкатегорий (bg-gray-100 rounded-full), стрелка ChevronRight с анимацией translate-x при ховере, адаптивный grid (1/2/3/4 колонки на разных разрешениях), состояние загрузки с красным спиннером и текстом "Загрузка каталога...", пустое состояние с иконкой Package и кнопкой возврата, СПЕЦИАЛЬНЫЕ ПРЕДЛОЖЕНИЯ внизу главной страницы: 3 градиентные карточки (Лучшая цена - синий градиент #0D336C, Новые поступления - зеленый #4DB45E, Распродажа - оранжевый #FF5F00) с иконками, описанием и стрелками, все карточки с hover эффектами (shadow-2xl, opacity transitions), шрифт Onest для всего текста, переходы transition-all duration-300, использованы корпоративные цвета (#EC1C24, #041124), удален Header так как Layout уже рендерит его, footer добавлен в конец - 50
54→Добавление полной иерархии breadcrumbs на страницу карточки товара - добавлен новый GraphQL запрос GET_PRODUCT_BY_ID в graphql.ts (строки 2269-2284) для получения продукта с категориями (id, name, article, brand, categories с полями id/name/slug/parentId), импортирован компонент CatalogInfoHeader и запросы GET_PRODUCT_BY_ID, GET_CATEGORIES в card.tsx (строки 19-20), добавлены два useQuery запроса для получения категорий и данных продукта (строки 65-75), реализованы функции findCategoryById и getCategoryPath для рекурсивного построения полного пути категорий от корня до текущей (строки 93-115), добавлен useMemo для categoryPath построения иерархии категорий продукта (строки 118-127), добавлен useMemo для breadcrumbs генерации хлебных крошек: Главная → Каталог → [все родительские категории] → Текущая категория (строки 130-144), добавлен компонент CatalogInfoHeader с полными breadcrumbs после InfoCard (строки 352-359), breadcrumbs отображаются только если их больше 2 (есть категории), исправлены SVG ошибки в трех компонентах: заменено width="currentwidth" height="currenthieght" на корректные числовые значения width="16" height="16" в CatalogInfoHeader.tsx (строка 74), width="30" height="18" в Header.tsx (строка 537), width="30" height="30" в InfoSearch.tsx (строка 25), теперь на странице карточки товара отображается полная иерархия категорий вместо неполной, breadcrumbs строятся рекурсивно через parentId обеспечивая корректное отображение всей цепочки от корня до конечной категории продукта - 20
Всего минут: 885
55→Добавление счетчика избранных товаров в шапку - создан компонент FavoriteButton.tsx аналогично CartButton с useFavorites хуком для получения favorites.length, заменена ссылка "Избранное" в Header.tsx на FavoriteButton с передачей handleProtectedNavigation, компонент использует Link вместо button для корректных hover эффектов от класса button_h, добавлен красный бейдж с классами pcs-info и text-block-39 показывающий количество товаров (отображается только если > 0), счетчик автоматически обновляется при изменении избранного благодаря реактивности FavoritesContext, исправлены проблемы с позиционированием и отсутствием hover эффектов - 10
56→Скрытие пустых артикулов при фильтрации результатов поиска - добавлена проверка в CoreProductCard.tsx для скрытия карточек без предложений после фильтров (строки 480-483), если нет предложений и нет кнопки загрузки - возвращается null вместо блока "Предложений не найдено", кнопка "Загрузить предложения" остается для незагруженных артикулов, теперь при фильтрации показываются только артикулы с подходящими предложениями без пустых блоков - 5
Всего минут: 905
57→Исправление удаления номера телефона в окне регистрации - добавлены комментарии в функции handlePhoneChange для ясности логики форматирования (PhoneInput.tsx:24-49), добавлен обработчик onKeyDown для предотвращения удаления префикса "+7 " при нажатии Backspace когда курсор в начале номера (строки 93-100), теперь пользователь может удалять цифры по одной а не блоками, префикс "+7 " защищен от удаления - 5
